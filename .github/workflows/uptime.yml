name: Uptime Monitor

on:
  schedule:
    # Runs every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allows manual trigger
  push:
    branches:
      - main

jobs:
  check-uptime:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: gh-pages
          
      - name: Check website status
        run: |
          # Configuration - Add your websites here
          cat > services.txt << 'EOL'
          Main Website|https://login.devpropvivo.com/login
          API Server|https://api.example.com
          Blog|https://blog.example.com
          EOL
          
          # Start JSON
          echo "{" > status.json
          echo "  \"lastUpdated\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"," >> status.json
          echo "  \"services\": [" >> status.json
          
          # Process services
          FIRST=true
          while IFS='|' read -r name url; do
            [ -z "$name" ] && continue
            
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              echo "," >> status.json
            fi
            
            # Check service
            START=$(date +%s%3N)
            HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" --max-time 10 "$url" || echo "0")
            END=$(date +%s%3N)
            RESPONSE_TIME=$((END - START))
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
              STATUS="operational"
            else
              STATUS="down"
            fi
            
            echo "    {" >> status.json
            echo "      \"name\": \"$name\"," >> status.json
            echo "      \"url\": \"$url\"," >> status.json
            echo "      \"status\": \"$STATUS\"," >> status.json
            echo "      \"statusCode\": $HTTP_CODE," >> status.json
            echo "      \"responseTime\": $RESPONSE_TIME" >> status.json
            echo "    }" >> status.json
          done < services.txt
          
          # Close JSON
          echo "" >> status.json
          echo "  ]" >> status.json
          echo "}" >> status.json
          
          # Validate JSON
          cat status.json
          
      - name: Generate HTML page
        run: |
          cat > index.html << 'EOF'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width,initial-scale=1">
            <title>Uptime Status</title>
            <style>
              body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;color:#111;padding:24px}
              .container{max-width:720px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;border:1px solid #e5e7eb}
              h1{font-size:20px;margin-bottom:8px}
              .service{display:flex;justify-content:space-between;padding:12px 8px;border-bottom:1px solid #eef2f7}
              .status.up{color:#065f46;font-weight:700}
              .status.down{color:#7f1d1d;font-weight:700}
              .meta{font-size:13px;color:#6b7280;margin-top:12px}
            </style>
          </head>
          <body>
            <div class="container">
              <h1>Uptime Status</h1>
              <div id="services">Loadingâ€¦</div>
              <div class="meta" id="lastUpdated"></div>
            </div>

            <script>
              async function loadStatus(){
                try{
                  const res = await fetch('status.json?t=' + Date.now());
                  const data = await res.json();

                  const servicesEl = document.getElementById('services');
                  servicesEl.innerHTML = '';

                  (data.services || []).forEach(s => {
                    const row = document.createElement('div');
                    row.className = 'service';

                    const name = document.createElement('div');
                    name.textContent = s.name || s.url || 'unknown';

                    const status = document.createElement('div');
                    status.className = 'status ' + (s.status === 'operational' ? 'up' : 'down');
                    status.textContent = s.status === 'operational' ? 'UP' : 'DOWN';

                    row.appendChild(name);
                    row.appendChild(status);
                    servicesEl.appendChild(row);
                  });

                  const lu = document.getElementById('lastUpdated');
                  if (data.lastUpdated) lu.textContent = 'Last checked: ' + new Date(data.lastUpdated).toLocaleString();
                }catch(err){
                console.log(err);
                  document.getElementById('services').innerHTML = '<div style="color:#b91c1c">Error loading status</div>';
                }
              }

              loadStatus();
              setInterval(loadStatus, 60000); // update every 60s
            </script>
          </body>
          </html>
          EOF
          
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add status.json index.html
          git diff --quiet && git diff --staged --quiet || git commit -m "Update status - $(date -u)"
          git push
